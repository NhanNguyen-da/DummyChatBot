<div class="chat-wrapper">
  <!-- Header -->
  <app-chat-header
    (resetChat)="onResetChat()"
    (toggleLanguage)="onLanguageToggle($event)">
  </app-chat-header>

  <!-- Welcome Screen -->
  @if (showWelcome) {
    <div class="welcome-screen">
      <div class="welcome-content">
        <div class="welcome-icon">
          <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="2"/>
            <path d="M40 20V60M20 40H60" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>

        <h1 class="welcome-title">Xin Chào!</h1>
        <p class="welcome-subtitle">
            Tôi là trợ lý sàng lọc bệnh nhân. Tôi sẽ giúp bạn tìm đúng chuyên khoa dựa trên các triệu chứng của bạn.
        </p>

        <button
          type="button"
          class="start-button"
          (click)="startConversation()">
          Bat Dau
        </button>

        <p class="privacy-notice">
          Thông tin của bạn sẽ được bảo mật và chỉ sử dụng cho mục đích sàng lọc.
        </p>
      </div>
    </div>
  }

  <!-- Chat Area -->
  @if (!showWelcome) {
    <div class="chat-container">
      <!-- Red Flag Warning Box -->
      @if (hasRedFlagAlert) {
        <div class="red-flag-warning-box">
          <div class="warning-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 9V13M12 17H12.01M5.07 19H18.93C20.07 19 20.77 17.77 20.2 16.79L13.27 4.49C12.7 3.51 11.3 3.51 10.73 4.49L3.8 16.79C3.23 17.77 3.93 19 5.07 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="warning-content">
            <span class="warning-title">Code Blue - Cảnh báo y tế khẩn cấp</span>
            <span class="warning-message">Hệ thống sẽ tự động liên hệ với y tá gần nhất để hỗ trợ bạn.</span>
            <span class="warning-message">Xin hãy ở nguyên vị trí.</span>
          </div>
        </div>
      }

      <!-- Messages Area -->
      <div
        #messagesContainer
        class="messages-area"
        (scroll)="onScroll($event)">
        <div class="messages-content">
          @for (message of conversationState.messages; track message.id) {
            <app-message [message]="message"></app-message>

            <!-- Department Card (after message with recommendation) -->
            @if (message.departmentCard) {
              <app-department-card
                [department]="message.departmentCard"
                (bookAppointment)="onBookAppointment($event)"
                (startOver)="onStartOver()">
              </app-department-card>
            }
          }

          <!-- Quick Replies (show only for last bot message, hide when red flag) -->
          @if (lastMessageQuickReplies && !conversationState.isTyping && !hasRedFlagAlert) {
            <app-quick-reply
              [replies]="lastMessageQuickReplies"
              (replySelected)="onQuickReplySelected($event)">
            </app-quick-reply>
          }

          <!-- Typing Indicator -->
          @if (conversationState.isTyping) {
            <app-typing-indicator></app-typing-indicator>
          }
        </div>
      </div>

      <!-- Scroll to Bottom Button -->
      @if (showScrollButton) {
        <button
          type="button"
          class="scroll-button"
          (click)="scrollToBottom()"
          aria-label="Cuon xuong cuoi">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M19 14L12 21L5 14M19 5L12 12L5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      }

      <!-- Input Area -->
      <app-input-area
        #inputArea
        [disabled]="isInputDisabled"
        (messageSent)="onMessageSent($event)">
      </app-input-area>
    </div>
  }
</div>
